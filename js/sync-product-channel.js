
        const productsData = {
            shopify: [
                {
                    id: 1,
                    title: "Beauty and the Boast-Victorian Fairy Tale Watch",
                    category: "Watch Collection",
                    tags: ["Fairy Tale", "Victorian", "Luxury", "Shopify"],
                    image: "https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "active",
                    stock: 12,
                    mapping: "unmapped",
                    platform: "shopify",
                    variants: [
                        {
                            id: 1,
                            title: "39 mm Silver Case",
                            description: "Silver Case, Leather Strap",
                            image: "https://images.unsplash.com/photo-1547996160-81bc1a7b3d71?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "SHOP-WATCH-SILVER",
                            weight: "0.5 Pounds",
                            price: "£175.00",
                            quantity: 8,
                            mapping: "unmapped"
                        },
                        {
                            id: 2,
                            title: "36 mm Gold Case",
                            description: "Gold Case, Leather Strap",
                            image: "https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "SHOP-WATCH-GOLD",
                            weight: "0.5 Pounds",
                            price: "£195.00",
                            quantity: 4,
                            mapping: "mapped"
                        }
                    ]
                },
                {
                    id: 2,
                    title: "Vintage Leather Headphones",
                    category: "Audio & Sound",
                    tags: ["Vintage", "Leather", "Premium", "Featured", "Shopify"],
                    image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "active",
                    stock: 25,
                    mapping: "mapped",
                    platform: "shopify",
                    variants: [
                        {
                            id: 1,
                            title: "Black Leather",
                            description: "Over-ear, Noise Cancelling",
                            image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "SHOP-HPH-VNT-BLK",
                            weight: "1.2 Pounds",
                            price: "£89.99",
                            quantity: 15,
                            mapping: "mapped"
                        },
                        {
                            id: 2,
                            title: "Brown Leather",
                            description: "Over-ear, Noise Cancelling",
                            image: "https://images.unsplash.com/photo-1583394838336-acd977736f90?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "SHOP-HPH-VNT-BRN",
                            weight: "1.2 Pounds",
                            price: "£94.99",
                            quantity: 10,
                            mapping: "mapped"
                        }
                    ]
                },
                {
                    id: 3,
                    title: "Wireless Bluetooth Earbuds",
                    category: "Audio & Sound",
                    tags: ["Wireless", "Bluetooth", "Noise Cancelling", "Shopify"],
                    image: "https://images.unsplash.com/photo-1590658165737-15a047b8b5e6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "pending",
                    stock: 5,
                    mapping: "unmapped",
                    platform: "shopify",
                    variants: [
                        {
                            id: 1,
                            title: "Black",
                            description: "Wireless, Noise Cancelling",
                            image: "https://images.unsplash.com/photo-1590658165737-15a047b8b5e6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "SHOP-EBD-BLK-01",
                            weight: "0.3 Pounds",
                            price: "£129.99",
                            quantity: 5,
                            mapping: "unmapped"
                        }
                    ]
                }
            ],
            wix: [
                {
                    id: 4,
                    title: "Premium Coffee Maker",
                    category: "Home & Kitchen",
                    tags: ["Premium", "Automatic", "Programmable", "Wix"],
                    image: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "private",
                    stock: 0,
                    mapping: "mapped",
                    platform: "wix",
                    variants: [
                        {
                            id: 1,
                            title: "Stainless Steel",
                            description: "12-cup Programmable",
                            image: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WIX-CFM-STL-12",
                            weight: "8.5 Pounds",
                            price: "£199.99",
                            quantity: 0,
                            mapping: "mapped"
                        }
                    ]
                },
                {
                    id: 5,
                    title: "Smart Fitness Watch",
                    category: "Wearables",
                    tags: ["Smart", "Fitness", "Health", "Wix"],
                    image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "active",
                    stock: 18,
                    mapping: "unmapped",
                    platform: "wix",
                    variants: [
                        {
                            id: 1,
                            title: "Black, 44mm",
                            description: "GPS, Heart Rate Monitor",
                            image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WIX-WATCH-BLK-44",
                            weight: "0.3 Pounds",
                            price: "£249.99",
                            quantity: 12,
                            mapping: "unmapped"
                        },
                        {
                            id: 2,
                            title: "Silver, 40mm",
                            description: "GPS, Heart Rate Monitor",
                            image: "https://images.unsplash.com/photo-1579586337278-3f9d2c6c1c3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WIX-WATCH-SIL-40",
                            weight: "0.3 Pounds",
                            price: "£239.99",
                            quantity: 6,
                            mapping: "mapped"
                        }
                    ]
                }
            ],
            woocommerce: [
                {
                    id: 6,
                    title: "Ergonomic Office Chair",
                    category: "Office Furniture",
                    tags: ["Ergonomic", "Office", "Comfort", "WooCommerce"],
                    image: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "active",
                    stock: 7,
                    mapping: "mapped",
                    platform: "woocommerce",
                    variants: [
                        {
                            id: 1,
                            title: "Black Mesh",
                            description: "Adjustable height, lumbar support",
                            image: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WOO-CHAIR-BLK-MSH",
                            weight: "25.0 Pounds",
                            price: "£299.99",
                            quantity: 4,
                            mapping: "mapped"
                        },
                        {
                            id: 2,
                            title: "Gray Fabric",
                            description: "Adjustable height, lumbar support",
                            image: "https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WOO-CHAIR-GRY-FAB",
                            weight: "26.0 Pounds",
                            price: "£329.99",
                            quantity: 3,
                            mapping: "unmapped"
                        }
                    ]
                },
                {
                    id: 7,
                    title: "Organic Cotton T-Shirt",
                    category: "Apparel",
                    tags: ["Organic", "Cotton", "Sustainable", "WooCommerce"],
                    image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80",
                    status: "pending",
                    stock: 32,
                    mapping: "unmapped",
                    platform: "woocommerce",
                    variants: [
                        {
                            id: 1,
                            title: "Small, White",
                            description: "100% Organic Cotton",
                            image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WOO-TSHT-S-WHT",
                            weight: "0.4 Pounds",
                            price: "£24.99",
                            quantity: 10,
                            mapping: "unmapped"
                        },
                        {
                            id: 2,
                            title: "Medium, White",
                            description: "100% Organic Cotton",
                            image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WOO-TSHT-M-WHT",
                            weight: "0.4 Pounds",
                            price: "£24.99",
                            quantity: 12,
                            mapping: "unmapped"
                        },
                        {
                            id: 3,
                            title: "Large, White",
                            description: "100% Organic Cotton",
                            image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=80&q=80",
                            sku: "WOO-TSHT-L-WHT",
                            weight: "0.4 Pounds",
                            price: "£24.99",
                            quantity: 10,
                            mapping: "unmapped"
                        }
                    ]
                }
            ]
        };

        // State management
        let currentPlatform = 'shopify';
        let products = [...productsData[currentPlatform]];
        let filters = {
            status: 'all',
            mapping: 'all',
            stock: 'all',
            search: ''
        };

        // Image upload variables
        let currentProductId = null;
        let currentVariantId = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function () {
            renderProducts();
            renderActiveFilters();
            initializeEventListeners();
            initializeImageUpload();
            updateFilterUI(); // Initialize filter UI
            
            // Add click handler for filters button (for touch devices)
            document.getElementById('filtersBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('filterDropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.filter-dropdown-container')) {
                    const dropdown = document.getElementById('filterDropdown');
                    if (window.innerWidth > 768) {
                        dropdown.style.display = 'none';
                    }
                }
            });
        });

        // Render products to the table
        function renderProducts() {
            const tableBody = document.getElementById('productTableBody');
            const noProductsMessage = document.getElementById('noProductsMessage');

            // Filter products based on current filters
            const filteredProducts = filterProducts(products);

            if (filteredProducts.length === 0) {
                tableBody.innerHTML = '';
                noProductsMessage.style.display = 'block';
                return;
            }

            noProductsMessage.style.display = 'none';
            tableBody.innerHTML = '';

            filteredProducts.forEach(product => {
                // Product row
                const productRow = document.createElement('tr');
                productRow.className = 'product-row';
                productRow.dataset.productId = product.id;

                productRow.innerHTML = `
                    <td>
                        <div class="checkbox-container">
                            <input type="checkbox" class="product-checkbox" data-product-id="${product.id}">
                        </div>
                    </td>
                    <td>
                        <div class="product-info">
                            <div class="product-title">
                                ${product.title}
                                <i class="fas fa-chevron-right arrow-icon"></i>
                            </div>
                            <div class="product-category">${product.category}</div>
                            <div class="product-tags">
                                ${product.tags.map(tag => `
                                    <span class="tag ${tag === 'Featured' ? 'featured' : (tag === 'Shopify' || tag === 'Wix' || tag === 'WooCommerce') ? 'platform' : ''}">${tag}</span>
                                `).join('')}
                            </div>
                        </div>
                    </td>
                    <td>
                        <img src="${product.image}" alt="Product" class="product-image">
                    </td>
                    <td>
                        <span class="status status-${product.status}">
                            <i class="fas fa-circle" style="font-size: 8px;"></i>
                            ${capitalizeFirstLetter(product.status)}
                        </span>
                    </td>
                    <td>
                        <div style="font-weight: 600; color: #0f172a;">${product.stock}</div>
                        <div style="font-size: 13px; color: #64748b;">In Stock</div>
                    </td>
                    <td>
                        <span class="mapping-status ${product.mapping}">${capitalizeFirstLetter(product.mapping)}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn-icon copy-link" title="Copy Link" data-product-id="${product.id}">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="action-btn-icon delete-btn" title="Delete" data-product-id="${product.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tableBody.appendChild(productRow);

                // Variant section row
                const variantRow = document.createElement('tr');
                variantRow.className = 'variant-section-row';

                variantRow.innerHTML = `
                    <td colspan="7">
                        <div class="expanded-variant-section" id="variant-section-${product.id}">
                            <div class="expanded-variant-content">
                                <div class="expanded-variant-header">
                                    <h3><i class="fas fa-layer-group"></i> Variant Management</h3>
                                    <div class="variant-actions">
                                        <button class="variant-action-btn primary add-variant-btn" data-product-id="${product.id}">
                                            <i class="fas fa-plus"></i> Add Variant
                                        </button>
                                        <button class="variant-action-btn sync-all-variants-btn" data-product-id="${product.id}">
                                            <i class="fas fa-sync-alt"></i> Sync All
                                        </button>
                                        <button class="variant-action-btn map-all-variants-btn" data-product-id="${product.id}">
                                            <i class="fas fa-map-marker-alt"></i> Map All
                                        </button>
                                        <button class="variant-action-btn primary save-variants-btn" data-product-id="${product.id}">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                                <table class="variant-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th style="width: 100px;">Image</th>
                                            <th>Variant Details</th>
                                            <th style="width: 150px;">SKU</th>
                                            <th style="width: 120px;">Weight</th>
                                            <th style="width: 120px;">Price</th>
                                            <th style="width: 100px;">Quantity</th>
                                            <th style="width: 130px;">Mapping</th>
                                            <th style="width: 180px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="variant-table-${product.id}">
                                        ${product.variants.map((variant, index) => `
                                            <tr>
                                                <td>
                                                    <div class="variant-number">${index + 1}</div>
                                                </td>
                                                <td class="image-upload-cell">
                                                    ${variant.image ? `
                                                        <img src="${variant.image}" alt="Variant" class="variant-image">
                                                    ` : `
                                                        <div class="variant-image-placeholder">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    `}
                                                    <button class="upload-image-btn" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                        <i class="fas fa-camera"></i> ${variant.image ? 'Change' : 'Add Image'}
                                                    </button>
                                                </td>
                                                <td>
                                                    <strong>${variant.title}</strong>
                                                    <div style="font-size: 13px; color: #64748b; margin-top: 4px;">${variant.description}</div>
                                                </td>
                                                <td>
                                                    <input type="text" class="input-field sku-input" placeholder="Enter SKU" 
                                                        value="${variant.sku}" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                </td>
                                                <td>
                                                    <input type="text" class="input-field weight-input" 
                                                        value="${variant.weight}" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                </td>
                                                <td>
                                                    <input type="text" class="input-field price-input" 
                                                        value="${variant.price}" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                </td>
                                                <td>
                                                    <input type="number" class="input-field quantity-input" 
                                                        value="${variant.quantity}" min="0" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                </td>
                                                <td>
                                                    <span class="mapping-status ${variant.mapping}">${capitalizeFirstLetter(variant.mapping)}</span>
                                                </td>
                                                <td>
                                                    <div class="variant-actions-cell">
                                                        <button class="variant-action-icon primary map-variant-btn" 
                                                            title="Map Variant" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                            <i class="fas fa-map-marker-alt"></i>
                                                        </button>
                                                        <button class="variant-action-icon warning sync-variant-btn" 
                                                            title="Sync Variant" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </button>
                                                        <button class="variant-action-icon delete-variant-btn" 
                                                            title="Delete Variant" data-product-id="${product.id}" data-variant-id="${variant.id}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                `;

                tableBody.appendChild(variantRow);
            });

            // Re-attach event listeners
            attachProductRowListeners();
            attachVariantListeners();
            attachImageUploadListeners();
        }

        // Render active filters display
        function renderActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFiltersContainer');
            const activeFiltersBadge = document.getElementById('activeFiltersBadge');

            // Count active filters (excluding 'all' values)
            let activeFilterCount = 0;
            let activeFiltersHTML = '';

            Object.keys(filters).forEach(filterType => {
                if (filterType !== 'search' && filters[filterType] !== 'all') {
                    activeFilterCount++;

                    let displayText = '';
                    let displayValue = '';

                    switch (filterType) {
                        case 'status':
                            displayText = 'Status';
                            displayValue = capitalizeFirstLetter(filters[filterType]);
                            break;
                        case 'mapping':
                            displayText = 'Mapping';
                            displayValue = capitalizeFirstLetter(filters[filterType]);
                            break;
                        case 'stock':
                            displayText = 'Stock';
                            displayValue = filters[filterType] === 'in-stock' ? 'In Stock' :
                                filters[filterType] === 'out-of-stock' ? 'Out of Stock' :
                                    filters[filterType] === 'low-stock' ? 'Low Stock' :
                                        filters[filterType];
                            break;
                    }

                    if (displayValue) {
                        activeFiltersHTML += `
                            <div class="active-filter-tag">
                                <span>${displayText}: ${displayValue}</span>
                                <button class="remove-filter" data-filter-type="${filterType}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            });

            // Update badge
            if (activeFilterCount > 0) {
                activeFiltersBadge.textContent = activeFilterCount;
                activeFiltersBadge.style.display = 'flex';
            } else {
                activeFiltersBadge.style.display = 'none';
            }

            // Update active filters display
            if (activeFiltersHTML) {
                activeFiltersContainer.innerHTML = activeFiltersHTML + `
                    <button class="clear-all-filters" id="clearAllFilters">
                        Clear all
                    </button>
                `;

                // Add event listeners to remove filter buttons
                document.querySelectorAll('.remove-filter').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const filterType = this.dataset.filterType;
                        filters[filterType] = 'all';
                        updateFilterUI();
                        renderProducts();
                        renderActiveFilters();
                    });
                });

                // Add event listener to clear all filters
                document.getElementById('clearAllFilters').addEventListener('click', function () {
                    filters = {
                        status: 'all',
                        mapping: 'all',
                        stock: 'all',
                        search: document.getElementById('searchInput').value.trim()
                    };
                    
                    updateFilterUI();
                    renderProducts();
                    renderActiveFilters();
                });

                activeFiltersContainer.style.display = 'flex';
            } else {
                activeFiltersContainer.style.display = 'none';
            }
        }

        // Update filter UI to reflect current filter states
        function updateFilterUI() {
            // Update all filter submenu options
            document.querySelectorAll('.filter-submenu-option').forEach(option => {
                const filterType = option.dataset.filter;
                const value = option.dataset.value;
                
                if (filters[filterType] === value) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Update main filter options (show which one is selected)
            document.querySelectorAll('.main-filter').forEach(filter => {
                const filterType = filter.dataset.filter;
                if (filters[filterType] !== 'all') {
                    filter.classList.add('active');
                } else {
                    filter.classList.remove('active');
                }
            });
        }

        // Filter products based on current filters
        function filterProducts(products) {
            return products.filter(product => {
                // Search filter
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const matchesSearch =
                        product.title.toLowerCase().includes(searchLower) ||
                        product.category.toLowerCase().includes(searchLower) ||
                        product.tags.some(tag => tag.toLowerCase().includes(searchLower)) ||
                        product.variants.some(variant =>
                            variant.title.toLowerCase().includes(searchLower) ||
                            variant.sku.toLowerCase().includes(searchLower)
                        );

                    if (!matchesSearch) return false;
                }

                // Status filter
                if (filters.status !== 'all' && product.status !== filters.status) {
                    return false;
                }

                // Mapping filter
                if (filters.mapping !== 'all' && product.mapping !== filters.mapping) {
                    return false;
                }

                // Stock filter
                if (filters.stock !== 'all') {
                    switch (filters.stock) {
                        case 'in-stock':
                            if (product.stock <= 0) return false;
                            break;
                        case 'out-of-stock':
                            if (product.stock > 0) return false;
                            break;
                        case 'low-stock':
                            if (product.stock >= 10 || product.stock === 0) return false;
                            break;
                    }
                }

                return true;
            });
        }

        // Initialize all event listeners
        function initializeEventListeners() {
            // Platform selection
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    currentPlatform = btn.dataset.platform;
                    products = [...productsData[currentPlatform]];
                    renderProducts();
                    showToast(`Platform switched to: ${capitalizeFirstLetter(currentPlatform)}`);
                });
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filters.search = this.value.trim();
                    renderProducts();
                }, 300);
            });

            // Filter submenu options
            document.querySelectorAll('.filter-submenu-option').forEach(option => {
                option.addEventListener('click', function (e) {
                    e.stopPropagation();
                    
                    const filterType = this.dataset.filter;
                    const value = this.dataset.value;
                    
                    // Update filter state
                    filters[filterType] = value;
                    
                    // Update UI
                    updateFilterUI();
                    
                    // Apply filters
                    renderProducts();
                    renderActiveFilters();
                    
                    // Close dropdown on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('filterDropdown').style.display = 'none';
                    }
                    
                    showToast(`Filter applied: ${filterType} = ${value}`);
                });
            });

            // Bulk Actions
            const bulkActionsBtn = document.getElementById('bulkActionsBtn');
            const bulkDropdown = document.getElementById('bulkDropdown');

            bulkActionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                bulkDropdown.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!bulkActionsBtn.contains(e.target) && !bulkDropdown.contains(e.target)) {
                    bulkDropdown.classList.remove('show');
                }
            });

            // Select all checkbox
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.product-checkbox:not(:disabled)');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function () {
                const refreshIcon = this.querySelector('i');
                refreshIcon.style.transition = 'transform 0.5s';
                refreshIcon.style.transform = 'rotate(360deg)';

                showToast('Refreshing data...');

                setTimeout(() => {
                    refreshIcon.style.transform = 'rotate(0deg)';
                    products = [...productsData[currentPlatform]];
                    renderProducts();
                    showToast('Data refreshed successfully!');
                }, 1000);
            });

            // Bulk Actions Functionality
            document.querySelectorAll('.bulk-option').forEach(option => {
                option.addEventListener('click', function () {
                    const action = this.dataset.action;
                    const selectedProducts = getSelectedProducts();

                    if (selectedProducts.length === 0) {
                        showToast('Please select at least one product first!', 'warning');
                        bulkDropdown.classList.remove('show');
                        return;
                    }

                    bulkDropdown.classList.remove('show');

                    switch (action) {
                        case 'set-active':
                            bulkSetStatus(selectedProducts, 'active');
                            break;
                        case 'set-pending':
                            bulkSetStatus(selectedProducts, 'pending');
                            break;
                        case 'set-private':
                            bulkSetStatus(selectedProducts, 'private');
                            break;
                        case 'set-rejected':
                            bulkSetStatus(selectedProducts, 'rejected');
                            break;
                        case 'delete':
                            bulkDeleteProducts(selectedProducts);
                            break;
                    }
                });
            });
        }

        // Initialize image upload functionality
        function initializeImageUpload() {
            const imageUploadModal = document.getElementById('imageUploadModal');
            const imageUploadInput = document.getElementById('imageUploadInput');
            const imagePreview = document.getElementById('imagePreview');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const uploadImageBtn = document.getElementById('uploadImage');
            const cancelUploadBtn = document.getElementById('cancelUpload');
            const closeModalBtn = document.getElementById('closeModal');

            // Close modal functions
            closeModalBtn.addEventListener('click', closeUploadModal);
            cancelUploadBtn.addEventListener('click', closeUploadModal);

            // Close modal when clicking outside the content
            imageUploadModal.addEventListener('click', function (e) {
                if (e.target === imageUploadModal) {
                    closeUploadModal();
                }
            });

            // Trigger file input when clicking on preview container
            document.getElementById('imagePreviewContainer').addEventListener('click', function () {
                imageUploadInput.click();
            });

            // Handle file selection
            imageUploadInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        uploadPlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle image upload
            uploadImageBtn.addEventListener('click', function () {
                if (imagePreview.src && currentProductId && currentVariantId) {
                    const product = products.find(p => p.id == currentProductId);
                    const variant = product.variants.find(v => v.id == currentVariantId);

                    if (variant) {
                        variant.image = imagePreview.src;

                        // If this is the FIRST variant, update product thumbnail
                        if (product.variants.length && product.variants[0].id == currentVariantId) {
                            product.image = imagePreview.src;
                        }

                        renderProducts();
                        showToast('Image uploaded successfully!');
                        closeUploadModal();
                    }
                } else {
                    showToast('Please select an image first!', 'warning');
                }
            });
        }

        // Attach image upload listeners to buttons
        function attachImageUploadListeners() {
            document.querySelectorAll('.upload-image-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const variantId = this.dataset.variantId;

                    openImageUploadModal(productId, variantId);
                });
            });
        }

        function openImageUploadModal(productId, variantId) {
            currentProductId = parseInt(productId);
            currentVariantId = parseInt(variantId);
            const modal = document.getElementById('imageUploadModal');
            modal.classList.add('show');
            resetUploadModal();
        }

        function closeUploadModal() {
            const modal = document.getElementById('imageUploadModal');
            modal.classList.remove('show');
            resetUploadModal();
        }

        function resetUploadModal() {
            const imagePreview = document.getElementById('imagePreview');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const imageUploadInput = document.getElementById('imageUploadInput');

            imagePreview.style.display = 'none';
            uploadPlaceholder.style.display = 'block';
            imagePreview.src = '';
            imageUploadInput.value = '';
        }

        // Attach event listeners to product rows
        function attachProductRowListeners() {
            // Expand/collapse product rows
            document.querySelectorAll('.product-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox' ||
                        e.target.closest('.action-btn-icon') ||
                        e.target.closest('.checkbox-container')) {
                        return;
                    }

                    const productId = row.dataset.productId;
                    const variantSection = document.getElementById(`variant-section-${productId}`);
                    const arrowIcon = row.querySelector('.arrow-icon');

                    // Close other expanded sections
                    document.querySelectorAll('.expanded-variant-section').forEach(section => {
                        if (section !== variantSection) {
                            section.classList.remove('show');
                        }
                    });

                    document.querySelectorAll('.product-row').forEach(otherRow => {
                        if (otherRow !== row) {
                            otherRow.classList.remove('expanded');
                        }
                    });

                    // Toggle current section
                    row.classList.toggle('expanded');
                    if (row.classList.contains('expanded')) {
                        variantSection.classList.add('show');
                        arrowIcon.style.transform = 'rotate(90deg)';
                    } else {
                        variantSection.classList.remove('show');
                        arrowIcon.style.transform = 'rotate(0deg)';
                    }
                });
            });

            // Copy link buttons
            document.querySelectorAll('.copy-link').forEach(button => {
                button.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const product = products.find(p => p.id == productId);

                    // Create a dummy URL (in real app, this would be the actual product URL)
                    const productUrl = `https://${currentPlatform}.com/products/${productId}`;

                    try {
                        await navigator.clipboard.writeText(productUrl);
                        showToast('Product link copied to clipboard!');
                    } catch (err) {
                        showToast('Failed to copy link', 'error');
                    }
                });
            });

            // Delete product buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const product = products.find(p => p.id == productId);

                    if (confirm(`Are you sure you want to delete "${product.title}"? This action cannot be undone.`)) {
                        products = products.filter(p => p.id != productId);
                        renderProducts();
                        showToast(`Product "${product.title}" deleted successfully`);
                    }
                });
            });
        }

        // Attach event listeners to variant elements
        function attachVariantListeners() {
            // Bulk variant actions
            document.querySelectorAll('.sync-all-variants-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    showToast(`Syncing all variants for product ${productId}...`);

                    // Simulate API call
                    setTimeout(() => {
                        showToast('All variants synced successfully!');
                    }, 1500);
                });
            });

            document.querySelectorAll('.map-all-variants-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const product = products.find(p => p.id == productId);

                    if (confirm(`Map all unmapped variants for "${product.title}"?`)) {
                        product.variants.forEach(variant => {
                            if (variant.mapping === 'unmapped') {
                                variant.mapping = 'mapped';
                            }
                        });

                        // Update product mapping status if all variants are mapped
                        if (product.variants.every(v => v.mapping === 'mapped')) {
                            product.mapping = 'mapped';
                        }

                        renderProducts();
                        showToast(`${product.variants.length} variants have been mapped successfully!`);
                    }
                });
            });

            document.querySelectorAll('.save-variants-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const product = products.find(p => p.id == productId);

                    // Collect all variant data from inputs
                    const skuInputs = document.querySelectorAll(`.sku-input[data-product-id="${productId}"]`);
                    const weightInputs = document.querySelectorAll(`.weight-input[data-product-id="${productId}"]`);
                    const priceInputs = document.querySelectorAll(`.price-input[data-product-id="${productId}"]`);
                    const quantityInputs = document.querySelectorAll(`.quantity-input[data-product-id="${productId}"]`);

                    skuInputs.forEach((input, index) => {
                        product.variants[index].sku = input.value;
                    });

                    weightInputs.forEach((input, index) => {
                        product.variants[index].weight = input.value;
                    });

                    priceInputs.forEach((input, index) => {
                        product.variants[index].price = input.value;
                    });

                    quantityInputs.forEach((input, index) => {
                        product.variants[index].quantity = parseInt(input.value) || 0;
                    });

                    // Update total stock
                    product.stock = product.variants.reduce((total, variant) => total + variant.quantity, 0);

                    showToast('Variant changes saved successfully!');
                });
            });

            // Individual variant actions
            document.querySelectorAll('.map-variant-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const variantId = this.dataset.variantId;
                    const product = products.find(p => p.id == productId);
                    const variant = product.variants.find(v => v.id == variantId);

                    variant.mapping = variant.mapping === 'unmapped' ? 'mapped' : 'unmapped';

                    // Update product mapping status
                    if (product.variants.every(v => v.mapping === 'mapped')) {
                        product.mapping = 'mapped';
                    } else {
                        product.mapping = 'unmapped';
                    }

                    renderProducts();
                    showToast(`Variant "${variant.title}" ${variant.mapping === 'mapped' ? 'mapped' : 'unmapped'} successfully!`);
                });
            });

            document.querySelectorAll('.sync-variant-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const variantId = this.dataset.variantId;
                    const product = products.find(p => p.id == productId);
                    const variant = product.variants.find(v => v.id == variantId);

                    showToast(`Syncing variant "${variant.title}"...`);

                    // Simulate API call
                    setTimeout(() => {
                        showToast(`Variant "${variant.title}" synced successfully!`);
                    }, 1000);
                });
            });

            document.querySelectorAll('.delete-variant-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const variantId = this.dataset.variantId;
                    const product = products.find(p => p.id == productId);
                    const variantIndex = product.variants.findIndex(v => v.id == variantId);

                    if (variantIndex !== -1 && confirm(`Are you sure you want to delete this variant?`)) {
                        const variant = product.variants[variantIndex];
                        product.variants.splice(variantIndex, 1);

                        // Update product stock
                        product.stock = product.variants.reduce((total, v) => total + v.quantity, 0);

                        renderProducts();
                        showToast(`Variant deleted successfully!`);
                    }
                });
            });

            // Add variant button
            document.querySelectorAll('.add-variant-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.dataset.productId;
                    const product = products.find(p => p.id == productId);

                    const newVariantId = product.variants.length > 0
                        ? Math.max(...product.variants.map(v => v.id)) + 1
                        : 1;

                    product.variants.push({
                        id: newVariantId,
                        title: `New Variant ${newVariantId}`,
                        description: "Add description here",
                        image: "",
                        sku: "",
                        weight: "0 Pounds",
                        price: "£0.00",
                        quantity: 0,
                        mapping: "unmapped"
                    });

                    renderProducts();
                    showToast(`New variant added to "${product.title}"!`);
                });
            });
        }

        // Bulk Actions Helper Functions
        function getSelectedProducts() {
            const selected = [];
            document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
                selected.push(parseInt(checkbox.dataset.productId));
            });
            return selected;
        }

        function bulkSetStatus(productIds, status) {
            productIds.forEach(productId => {
                const product = products.find(p => p.id == productId);
                if (product) {
                    product.status = status;
                }
            });

            renderProducts();
            showToast(`${productIds.length} product(s) status updated to ${status}`);
        }

        function bulkDeleteProducts(productIds) {
            if (confirm(`Are you sure you want to delete ${productIds.length} selected product(s)? This action cannot be undone.`)) {
                products = products.filter(product => !productIds.includes(product.id));
                renderProducts();
                showToast(`${productIds.length} product(s) deleted successfully`);
            }
        }

        // Helper function
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/product-detail.css" />

</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <a href="product-list.html" class="back-button">
          <i class="fas fa-arrow-left"></i>
        </a>
        <h1>Product Details</h1>
        <p>View and manage product information</p>
      </div>
      <div class="header-right">
        <div class="user-profile">
          <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="Admin User" />
          <div>

            <h4>Admin User</h4>
            <p>Super Admin</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Product Not Found -->
    <div id="productNotFound" style="display: none;">
      <div
        style="text-align: center; padding: 50px; background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
        <h2>Product Not Found</h2>
        <p>The requested product could not be found.</p>
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="goToProductsList()">
          <i class="fas fa-arrow-left"></i> Back to Products List
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div id="productDetail" style="display: none">
      <div class="main-content">
        <!-- Left Column - Images -->
        <div class="image-section">
          <div class="main-image-container">
            <img id="mainImage" class="main-image" alt="Product Image" />
            <div id="imagePlaceholder" class="image-placeholder">
              <i class="fas fa-box-open"></i>
              <span>No image available</span>
            </div>
            <label class="image-upload-btn edit-mode-element">
              <i class="fas fa-camera"></i> Change Image
              <input type="file" accept="image/*" hidden onchange="changeProductImage(event)" />
            </label>
          </div>
          <div class="thumbnail-container" id="thumbnailsContainer">
            <!-- Thumbnails will be dynamically added -->
          </div>
        </div>

        <!-- Right Column - Form -->
        <div class="form-section">
          <!-- Product Header -->
          <div class="product-header">
            <div class="product-title">
              <h2 id="productName" class="view-mode">Loading...</h2>
              <div class="form-group edit-mode-element" style="display: none;">
                <input type="text" id="editProductName" class="edit-mode-input" />
              </div>
              <div class="product-meta">
                <span id="productSku" class="product-sku view-mode">SKU: Loading...</span>
                <div class="form-group edit-mode-element" style="display: none; width: 200px;">
                  <input type="text" id="editProductSku" class="edit-mode-input" />
                </div>
                <!-- FIXED: Changed ID to avoid duplicate -->
                <span id="statusBadge" class="badge pending view-mode">Pending</span>
                <span id="productFeatured" class="badge featured view-mode" style="display: none;">
                  <i class="fas fa-star"></i> Featured
                </span>
              </div>
            </div>
            <button class="btn btn-warning" onclick="toggleEditMode()" id="editButton">
              <i class="fas fa-edit"></i> Edit
            </button>
          </div>

          <!-- Price Section -->
          <div class="price-section">
            <div class="price-display">
              <div class="view-mode">
                <span class="original-price" id="originalPrice">$0.00</span>
                <span class="current-price" id="currentPrice">$0.00</span>
                <span class="discount-badge" id="discountBadge">Save 0%</span>
              </div>
              <div class="form-group edit-mode-element" style="display: none;">
                <div class="form-row">
                  <div>
                    <label>Price ($)</label>
                    <input type="number" step="0.01" id="editPrice" class="edit-mode-input" />
                  </div>
                  <div>
                    <label>Original Price ($)</label>
                    <input type="number" step="0.01" id="editOriginalPrice" class="edit-mode-input" />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group edit-mode-element" style="display: none;">
              <label>Stock Quantity</label>
              <input type="number" id="editStock" class="edit-mode-input" />
            </div>
          </div>

          <!-- Product Info -->
          <div class="mb-24">
            <div class="section-header">
              <h3>Product Information</h3>
            </div>

            <div class="form-group">
              <label class="required">Product Name</label>
              <div id="displayProductName" class="view-mode">Loading...</div>
              <input type="text" id="editProductNameFull" class="edit-mode-element edit-mode-input"
                style="display: none;" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Vendor</label>
                <div id="displayVendor" class="view-mode">Loading...</div>
                <select id="editVendor" class="edit-mode-element edit-mode-input" style="display: none;">
                  <option value="Amazon">Amazon</option>
                  <option value="Flipkart">Flipkart</option>
                  <option value="Meesho">Meesho</option>
                  <option value="Marchand Watch Company">Marchand Watch Company</option>
                </select>
              </div>

              <div class="form-group">
                <label>Status</label>
                <!-- FIXED: Changed ID to avoid duplicate -->
                <span id="statusBadge2" class="badge pending view-mode">Pending</span>
                <select id="editStatus" class="edit-mode-element edit-mode-input" style="display: none;">
                  <option value="active">Active</option>
                  <option value="pending">Pending</option>
                  <option value="private">Private</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Category</label>
              <div id="displayCategory" class="view-mode">Loading...</div>
              <select id="editCategory" class="edit-mode-element edit-mode-input" style="display: none;">
                <option value="Electronics">Electronics</option>
                <option value="Fashion">Fashion</option>
                <option value="Home & Kitchen">Home & Kitchen</option>
                <option value="Sports">Sports</option>
                <option value="Watch Accessories">Watch Accessories</option>
              </select>
            </div>

            <div class="form-group">
              <label>Tags</label>
              <div id="displayTags" class="tags-container view-mode">
                <!-- Tags will be dynamically added -->
              </div>
              <div class="tag-input edit-mode-element" style="display: none;">
                <input type="text" id="newTagInput" placeholder="Add a tag" class="edit-mode-input" />
                <button type="button" onclick="addTag()" class="edit-mode-input">Add</button>
              </div>
            </div>
          </div>

          <!-- Description -->
          <div class="mb-24">
            <div class="section-header">
              <h3>Description</h3>
            </div>
            <div class="form-group">
              <div id="displayDescription" class="view-mode">
                <p>Loading...</p>
              </div>
              <textarea id="editDescription" class="edit-mode-element edit-mode-input"
                style="display: none;"></textarea>
            </div>
          </div>

          <!-- Platforms -->
          <div class="variants-section">
            <div class="section-header">
              <h3>Platforms & Inventory</h3>
            </div>

            <div class="form-group">
              <label>Available Platforms</label>
              <div id="displayPlatforms" class="view-mode">
                <!-- Platforms will be displayed here -->
              </div>
              <div class="checkbox-group edit-mode-element" style="display: none;">
                <div class="checkbox-item">
                  <input type="checkbox" id="platformWeb" value="Web" class="edit-mode-input">
                  <label for="platformWeb">Web</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="platformAndroid" value="Android" class="edit-mode-input">
                  <label for="platformAndroid">Android</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="platformIOS" value="iOS" class="edit-mode-input">
                  <label for="platformIOS">iOS</label>
                </div>
              </div>
            </div>

            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Inventory</th>
                    <th>Pricing</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="view-mode">
                        <div><strong>Stock:</strong> <span id="displayQuantity">0</span></div>
                        <div><strong>SKU:</strong> <span id="displaySku">Loading...</span></div>
                        <div><strong>Date Added:</strong> <span id="displayDateAdded">Loading...</span></div>
                      </div>
                      <div class="edit-mode-element" style="display: none;">
                        <div class="form-group">
                          <label>Stock Quantity</label>
                          <input type="number" id="editQuantity" class="edit-mode-input" />
                        </div>
                        <div class="form-group">
                          <label>SKU</label>
                          <input type="text" id="editSku" class="edit-mode-input" />
                        </div>
                        <div class="form-group">
                          <label>Date Added</label>
                          <input type="date" id="editDateAdded" class="edit-mode-input" />
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="view-mode">
                        <div><strong>Price:</strong> $<span id="displayPriceValue">0.00</span></div>
                        <div><strong>Original Price:</strong> $<span id="displayOriginalPriceValue">0.00</span></div>
                        <div><strong>Discount:</strong> <span id="displayDiscountValue">0%</span></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Package Details -->
          <div class="mb-24">
            <div class="section-header">
              <h3>Package Details</h3>
            </div>
            <div class="package-details">
              <div class="package-group">
                <label>Weight</label>
                <div class="view-mode">0.5 kg</div>
                <input type="number" id="packageWeight" class="edit-mode-element edit-mode-input"
                  style="display: none;" />
              </div>
              <div class="package-group">
                <label>Dimensions</label>
                <div class="view-mode">10x10x5 cm</div>
                <div class="edit-mode-element" style="display: none;">
                  <input type="number" id="packageLength" placeholder="Length" class="edit-mode-input"
                    style="margin-bottom: 5px;" />
                  <input type="number" id="packageWidth" placeholder="Width" class="edit-mode-input"
                    style="margin-bottom: 5px;" />
                  <input type="number" id="packageHeight" placeholder="Height" class="edit-mode-input" />
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="toggleProductStatus('active')">
              <i class="fas fa-check-circle"></i> Set Active
            </button>
            <button class="btn btn-secondary" onclick="toggleProductStatus('private')">
              <i class="fas fa-eye-slash"></i> Set Private
            </button>
            <button class="btn btn-success" onclick="toggleFeatured()">
              <i class="fas fa-star"></i> Toggle Featured
            </button>
            <button class="btn btn-danger" onclick="deleteProduct()">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>

          <!-- Edit Mode Buttons -->
          <div class="edit-buttons">
            <button class="btn btn-outline" onclick="updateDraft()">
              <i class="fas fa-save"></i> Update Draft
            </button>
            <button class="btn btn-primary" onclick="saveProductChanges()">
              <i class="fas fa-check"></i> Save Changes
            </button>
            <button class="btn btn-secondary" onclick="cancelEdit()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="activity-section">
        <h3>Activity Timeline</h3>
        <div class="timeline" id="activityTimeline">

        </div>
      </div>
    </div>
  </div>

  <script>
    // Product data management
    let isEditMode = false;
    let currentProduct = null;
    let productTags = [];
    let originalProductData = null;
    let currentProductId = null;
    let productImages = [];

    // Product data from localStorage or default
    let products = JSON.parse(localStorage.getItem("products")) || [
      {
        id: 1,
        name: "Modern Doctor Lamp",
        sku: "LP-8242",
        vendor: "Made in Dubai, Latty",
        status: "private",
        category: "Home & Kitchen",
        price: 89.99,
        originalPrice: 99.99,
        stock: 12,
        platforms: ["iOS"],
        dateAdded: "2024-03-20",
        description: "Modern LED lamp for home decoration with adjustable brightness",
        images: [
          "https://images.unsplash.com/photo-1507473885765-e6ed057f782c?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1513506003901-1e6a229e2d15?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=400&h=400&fit=crop"
        ],
        isFeatured: false,
        tags: ["Home Decor", "Lighting", "Modern", "LED", "Doctor Lamp"],
        activity: [
          { date: "Today, 11:20 AM", content: "Product set to private status" },
          { date: "March 20, 2024", content: "Product added to inventory" },
          { date: "March 19, 2024", content: "Product shipped from Dubai" },
          { date: "March 15, 2024", content: "Product manufactured" }
        ]
      },
      {
        id: 2,
        name: "Smart Watch Pro X3",
        sku: "SW-1001",
        vendor: "Amazon",
        status: "active",
        category: "Electronics",
        price: 285.8,
        originalPrice: 299.99,
        stock: 45,
        platforms: ["Web", "Android", "iOS"],
        dateAdded: "2024-03-15",
        description: "Advanced smart watch with fitness tracking and notifications",
        images: [
          "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1508685096489-7aacd43bd3b1?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1546868871-7041f2a55e12?w=400&h=400&fit=crop"
        ],
        isFeatured: true,
        tags: ["Smartwatch", "Electronics", "Fitness", "Amazon"],
        activity: [
          { date: "Today, 10:30 AM", content: "Product viewed by 15 users" },
          { date: "Yesterday, 3:45 PM", content: "Price updated from $299.99 to $285.80" },
          { date: "March 18, 2024", content: "Product approved and marked as Active" },
          { date: "March 15, 2024", content: "Product added to the system" }
        ]
      },
      {
        id: 2,
        name: "Smart Watch Pro X3",
        sku: "SW-1001",
        vendor: "Amazon",
        status: "active",
        category: "Electronics",
        price: 285.8,
        originalPrice: 299.99,
        stock: 45,
        platforms: ["Web", "Android", "iOS"],
        dateAdded: "2024-03-15",
        description: "Advanced smart watch with fitness tracking and notifications",
        images: [
          "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1508685096489-7aacd43bd3b1?w=400&h=400&fit=crop",
          "https://images.unsplash.com/photo-1546868871-7041f2a55e12?w=400&h=400&fit=crop"
        ],
        isFeatured: true,
        tags: ["Smartwatch", "Electronics", "Fitness", "Amazon"],
        activity: [
          { date: "Today, 10:30 AM", content: "Product viewed by 15 users" },
          { date: "Yesterday, 3:45 PM", content: "Price updated from $299.99 to $285.80" },
          { date: "March 18, 2024", content: "Product approved and marked as Active" },
          { date: "March 15, 2024", content: "Product added to the system" }
        ]
      }
    ];

    // Initialize page
    document.addEventListener("DOMContentLoaded", function () {
      // Get product ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentProductId = parseInt(urlParams.get('id')) || 1;

      setTimeout(loadProductDetails, 500);
    });

    function loadProductDetails() {
      const loading = document.getElementById("loading");
      const productDetail = document.getElementById("productDetail");
      const productNotFound = document.getElementById("productNotFound");

      // Find product by ID
      currentProduct = products.find(p => p.id === currentProductId);

      if (!currentProduct) {
        loading.style.display = "none";
        productNotFound.style.display = "block";
        return;
      }

      loading.style.display = "none";
      productDetail.style.display = "block";
      productNotFound.style.display = "none";

      // Create a deep copy for original data
      originalProductData = JSON.parse(JSON.stringify(currentProduct));

      // Update tags array
      productTags = [...(currentProduct.tags || [])];

      // Initialize product images array
      productImages = currentProduct.images ? [...currentProduct.images] : [];

      // Update display
      updateProductDisplay();
    }

    function updateProductDisplay() {
      if (!currentProduct) return;

      console.log("Updating display for product:", currentProduct.name);
      console.log("Current status:", currentProduct.status);

      // Basic Info
      document.getElementById("productName").textContent = currentProduct.name;
      document.getElementById("editProductName").value = currentProduct.name;
      document.getElementById("editProductNameFull").value = currentProduct.name;
      document.getElementById("displayProductName").textContent = currentProduct.name;

      // SKU
      document.getElementById("productSku").textContent = `SKU: ${currentProduct.sku}`;
      document.getElementById("editProductSku").value = currentProduct.sku;
      document.getElementById("editSku").value = currentProduct.sku;
      document.getElementById("displaySku").textContent = currentProduct.sku;

      // Vendor
      document.getElementById("displayVendor").textContent = currentProduct.vendor;
      document.getElementById("editVendor").value = currentProduct.vendor;

      // Status - FIXED: Update both status badges
      const statusBadge1 = document.getElementById("statusBadge");
      const statusBadge2 = document.getElementById("statusBadge2");

      if (statusBadge1) {
        statusBadge1.className = `badge ${currentProduct.status}`;
        statusBadge1.textContent = currentProduct.status.charAt(0).toUpperCase() + currentProduct.status.slice(1);
      }

      if (statusBadge2) {
        statusBadge2.className = `badge ${currentProduct.status}`;
        statusBadge2.textContent = currentProduct.status.charAt(0).toUpperCase() + currentProduct.status.slice(1);
      }

      document.getElementById("editStatus").value = currentProduct.status;

      // Category
      document.getElementById("displayCategory").textContent = currentProduct.category;
      document.getElementById("editCategory").value = currentProduct.category;

      // Tags
      updateTagsDisplay();

      // Price and Discount
      document.getElementById("editPrice").value = currentProduct.price;
      document.getElementById("editOriginalPrice").value = currentProduct.originalPrice;
      document.getElementById("editStock").value = currentProduct.stock;

      document.getElementById("displayPriceValue").textContent = currentProduct.price.toFixed(2);
      document.getElementById("displayOriginalPriceValue").textContent = currentProduct.originalPrice.toFixed(2);
      const discount = Math.round((1 - currentProduct.price / currentProduct.originalPrice) * 100);
      document.getElementById("displayDiscountValue").textContent = `${discount}%`;

      document.getElementById("discountBadge").textContent = `Save ${discount}%`;
      document.getElementById("originalPrice").textContent = `$${currentProduct.originalPrice.toFixed(2)}`;
      document.getElementById("currentPrice").textContent = `$${currentProduct.price.toFixed(2)}`;

      // Description
      document.getElementById("displayDescription").innerHTML = `<p>${currentProduct.description}</p>`;
      document.getElementById("editDescription").value = currentProduct.description;

      // Quantity
      document.getElementById("editQuantity").value = currentProduct.stock;
      document.getElementById("displayQuantity").textContent = currentProduct.stock;

      // Platforms
      updatePlatformsDisplay();
      updatePlatformsEditMode();

      // Date Added
      document.getElementById("editDateAdded").value = currentProduct.dateAdded;
      document.getElementById("displayDateAdded").textContent = currentProduct.dateAdded;

      // Featured
      const featuredBadge = document.getElementById("productFeatured");
      if (currentProduct.isFeatured) {
        featuredBadge.style.display = "inline-flex";
      } else {
        featuredBadge.style.display = "none";
      }

      // Images
      updateProductImages();

      // Activity Timeline
      updateActivityTimeline();
    }

    function updateProductImages() {
      const mainImage = document.getElementById("mainImage");
      const imagePlaceholder = document.getElementById("imagePlaceholder");
      const thumbnailsContainer = document.getElementById("thumbnailsContainer");

      // Clear thumbnails
      thumbnailsContainer.innerHTML = '';

      // Main image - show first image if available
      if (productImages.length > 0) {
        mainImage.src = productImages[0];
        mainImage.style.display = "block";
        imagePlaceholder.style.display = "none";

        // Create thumbnails for all images with remove buttons
        productImages.forEach((imageSrc, index) => {
          const thumbnailWrapper = document.createElement("div");
          thumbnailWrapper.style.position = "relative";

          const thumbnail = document.createElement("img");
          thumbnail.src = imageSrc;
          thumbnail.className = 'thumbnail' + (index === 0 ? ' active' : '');
          thumbnail.alt = `Product Image ${index + 1}`;
          thumbnail.onclick = () => {
            // Change main image
            mainImage.src = imageSrc;

            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => {
              thumb.classList.remove('active');
            });
            thumbnail.classList.add('active');
          };

          // Add remove button in edit mode
          if (isEditMode) {
            const removeIcon = document.createElement("span");
            removeIcon.className = "remove-icon";
            removeIcon.innerHTML = '<i class="fas fa-times"></i>';
            removeIcon.onclick = (e) => {
              e.stopPropagation();
              removeImage(index);
            };
            thumbnailWrapper.appendChild(removeIcon);
          }

          thumbnailWrapper.appendChild(thumbnail);
          thumbnailsContainer.appendChild(thumbnailWrapper);
        });

        // Add plus button for adding more images in edit mode
        if (isEditMode) {
          const placeholder = document.createElement("div");
          placeholder.className = 'thumbnail remove-btn';
          placeholder.style.backgroundColor = '#f5f5f5';
          placeholder.style.display = 'flex';
          placeholder.style.alignItems = 'center';
          placeholder.style.justifyContent = 'center';
          placeholder.style.color = '#ccc';
          placeholder.style.cursor = 'pointer';
          placeholder.innerHTML = '<i class="fas fa-plus"></i>';
          placeholder.onclick = () => {
            // Trigger image upload
            document.querySelector('.image-upload-btn input').click();
          };
          thumbnailsContainer.appendChild(placeholder);
        }
      } else {
        // No images
        mainImage.style.display = "none";
        imagePlaceholder.style.display = "flex";

        // Show plus button in edit mode
        if (isEditMode) {
          const placeholder = document.createElement("div");
          placeholder.className = 'thumbnail remove-btn';
          placeholder.style.backgroundColor = '#f5f5f5';
          placeholder.style.display = 'flex';
          placeholder.style.alignItems = 'center';
          placeholder.style.justifyContent = 'center';
          placeholder.style.color = '#ccc';
          placeholder.style.cursor = 'pointer';
          placeholder.innerHTML = '<i class="fas fa-plus"></i>';
          placeholder.onclick = () => {
            // Trigger image upload
            document.querySelector('.image-upload-btn input').click();
          };
          thumbnailsContainer.appendChild(placeholder);
        }
      }
    }

    function removeImage(index) {
      if (productImages.length <= 1) {
        showNotification("At least one image is required", "error");
        return;
      }

      // Remove image from array
      productImages.splice(index, 1);

      // Update current product images
      if (currentProduct) {
        currentProduct.images = productImages;
      }

      // Update display
      updateProductImages();

      // Update main image if needed
      if (index === 0 && productImages.length > 0) {
        document.getElementById("mainImage").src = productImages[0];
      }

      showNotification("Image removed successfully", "success");
    }

    function updatePlatformsDisplay() {
      const platformsContainer = document.getElementById("displayPlatforms");
      if (currentProduct.platforms && currentProduct.platforms.length > 0) {
        platformsContainer.innerHTML = currentProduct.platforms.map(platform =>
          `<span class="tag" style="background: #e3f2fd; color: #1565c0;">${platform}</span>`
        ).join('');
      } else {
        platformsContainer.innerHTML = '<span class="text-muted">No platforms specified</span>';
      }
    }

    function updatePlatformsEditMode() {
      // Clear all checkboxes
      if (document.getElementById('platformWeb')) {
        document.getElementById('platformWeb').checked = false;
      }
      if (document.getElementById('platformAndroid')) {
        document.getElementById('platformAndroid').checked = false;
      }
      if (document.getElementById('platformIOS')) {
        document.getElementById('platformIOS').checked = false;
      }

      // Check the ones that are in current product
      if (currentProduct.platforms) {
        currentProduct.platforms.forEach(platform => {
          if (platform === 'Web' && document.getElementById('platformWeb')) {
            document.getElementById('platformWeb').checked = true;
          }
          if (platform === 'Android' && document.getElementById('platformAndroid')) {
            document.getElementById('platformAndroid').checked = true;
          }
          if (platform === 'iOS' && document.getElementById('platformIOS')) {
            document.getElementById('platformIOS').checked = true;
          }
        });
      }
    }
    function updateActivityTimeline() {
      const timeline = document.getElementById("activityTimeline");

      if (currentProduct.activity && currentProduct.activity.length > 0) {
        // Get only the last 3 activities
        const lastThreeActivities = currentProduct.activity.slice(-3);

        timeline.innerHTML = lastThreeActivities.map(item => `
      <div class="timeline-item">
        <div class="timeline-date">${item.date}</div>
        <div class="timeline-content">${item.content}</div>
      </div>
    `).join('');
      } else {
        timeline.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--gray); font-style: italic;">
        No activity recorded yet
      </div>
    `;
      }
    }
    function updateTagsDisplay() {
      const tagsContainer = document.getElementById("displayTags");
      if (productTags.length > 0) {
        tagsContainer.innerHTML = productTags.map(tag =>
          `<span class="tag">${tag} <span class="tag-remove" onclick="removeTag('${tag}')">Ã—</span></span>`
        ).join('');
      } else {
        tagsContainer.innerHTML = '<span class="text-muted">No tags added</span>';
      }
    }

    function addTag() {
      const input = document.getElementById("newTagInput");
      const tag = input.value.trim();

      if (tag && !productTags.includes(tag)) {
        productTags.push(tag);
        updateTagsDisplay();
        input.value = '';
      }
    }

    function removeTag(tagText) {
      productTags = productTags.filter(tag => tag !== tagText);
      updateTagsDisplay();
    }

    function changeProductImage(event) {
      const input = event.target;
      const reader = new FileReader();

      reader.onload = function () {
        const mainImage = document.getElementById("mainImage");
        const imagePlaceholder = document.getElementById("imagePlaceholder");
        const thumbnailsContainer = document.getElementById("thumbnailsContainer");

        // Add new image to array
        productImages.push(reader.result);

        // Update current product images
        if (currentProduct) {
          currentProduct.images = productImages;
        }

        // Update display
        mainImage.src = reader.result;
        mainImage.style.display = "block";
        imagePlaceholder.style.display = "none";

        // Update thumbnails
        updateProductImages();

        // Mark last thumbnail as active
        const thumbnails = document.querySelectorAll('.thumbnail');
        if (thumbnails.length > 0) {
          thumbnails.forEach(thumb => thumb.classList.remove('active'));
          if (thumbnails[productImages.length - 1]) {
            thumbnails[productImages.length - 1].classList.add('active');
          }
        }

        showNotification("Image added successfully!", "success");
      };

      if (input.files && input.files[0]) {
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Edit Mode Functions
    function toggleEditMode() {
      isEditMode = !isEditMode;

      if (isEditMode) {
        document.getElementById("productDetail").classList.add("edit-mode");
        document.getElementById("editButton").innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
        document.getElementById("editButton").onclick = cancelEdit;
      } else {
        document.getElementById("productDetail").classList.remove("edit-mode");
        document.getElementById("editButton").innerHTML = '<i class="fas fa-edit"></i> Edit';
        document.getElementById("editButton").onclick = toggleEditMode;
      }

      // Update thumbnails to show remove buttons
      updateProductImages();
    }

    function saveProductChanges() {
      if (!currentProduct) return;

      try {
        console.log("Saving product changes...");

        // Collect all data from form
        const productName = document.getElementById("editProductNameFull").value;
        const sku = document.getElementById("editSku").value;
        const vendor = document.getElementById("editVendor").value;
        const status = document.getElementById("editStatus").value;
        const category = document.getElementById("editCategory").value;
        const price = parseFloat(document.getElementById("editPrice").value) || 0;
        const originalPrice = parseFloat(document.getElementById("editOriginalPrice").value) || 0;
        const stock = parseInt(document.getElementById("editQuantity").value) || 0;
        const description = document.getElementById("editDescription").value;
        const dateAdded = document.getElementById("editDateAdded").value;

        console.log("Collected data:", {
          productName, sku, vendor, status, category,
          price, originalPrice, stock, description, dateAdded
        });

        // Update current product
        currentProduct.name = productName;
        currentProduct.sku = sku;
        currentProduct.vendor = vendor;
        currentProduct.status = status;
        currentProduct.category = category;
        currentProduct.price = price;
        currentProduct.originalPrice = originalPrice;
        currentProduct.stock = stock;
        currentProduct.description = description;
        currentProduct.dateAdded = dateAdded;
        currentProduct.tags = [...productTags];
        currentProduct.images = [...productImages];

        // Update platforms
        const platforms = [];
        if (document.getElementById('platformWeb') && document.getElementById('platformWeb').checked) platforms.push('Web');
        if (document.getElementById('platformAndroid') && document.getElementById('platformAndroid').checked) platforms.push('Android');
        if (document.getElementById('platformIOS') && document.getElementById('platformIOS').checked) platforms.push('iOS');
        currentProduct.platforms = platforms;

        // Ensure activity array exists
        if (!currentProduct.activity) {
          currentProduct.activity = [];
        }

        // Update timestamp and add activity
        const today = new Date();
        const timeString = today.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        // Add new activity
        currentProduct.activity.unshift({
          date: `Today, ${timeString}`,
          content: "Product details updated"
        });

        // Update in products array
        const index = products.findIndex(p => p.id === currentProduct.id);
        if (index !== -1) {
          products[index] = currentProduct;
          localStorage.setItem("products", JSON.stringify(products));
          console.log("Product saved to localStorage:", currentProduct);
        }

        // Update display
        updateProductDisplay();

        // Exit edit mode
        toggleEditMode();

        // Show success message
        showNotification("Product updated successfully!", "success");

      } catch (error) {
        console.error("Error saving product:", error);
        showNotification("Error saving product: " + error.message, "error");
      }
    }

    function updateDraft() {
      try {
        // Collect all data from form
        currentProduct.name = document.getElementById("editProductNameFull").value;
        currentProduct.sku = document.getElementById("editSku").value;
        currentProduct.vendor = document.getElementById("editVendor").value;
        currentProduct.status = document.getElementById("editStatus").value;
        currentProduct.category = document.getElementById("editCategory").value;
        currentProduct.price = parseFloat(document.getElementById("editPrice").value) || 0;
        currentProduct.originalPrice = parseFloat(document.getElementById("editOriginalPrice").value) || 0;
        currentProduct.stock = parseInt(document.getElementById("editQuantity").value) || 0;
        currentProduct.description = document.getElementById("editDescription").value;
        currentProduct.dateAdded = document.getElementById("editDateAdded").value;
        currentProduct.tags = [...productTags];
        currentProduct.images = [...productImages];

        // Update platforms
        const platforms = [];
        if (document.getElementById('platformWeb') && document.getElementById('platformWeb').checked) platforms.push('Web');
        if (document.getElementById('platformAndroid') && document.getElementById('platformAndroid').checked) platforms.push('Android');
        if (document.getElementById('platformIOS') && document.getElementById('platformIOS').checked) platforms.push('iOS');
        currentProduct.platforms = platforms;

        // Update in products array
        const index = products.findIndex(p => p.id === currentProduct.id);
        if (index !== -1) {
          products[index] = currentProduct;
          localStorage.setItem("products", JSON.stringify(products));
        }

        showNotification("Product draft saved successfully!", "info");

      } catch (error) {
        console.error("Error saving draft:", error);
        showNotification("Error saving draft: " + error.message, "error");
      }
    }

    function cancelEdit() {
      // Restore original data
      if (originalProductData) {
        Object.assign(currentProduct, originalProductData);
        productTags = [...originalProductData.tags];
        productImages = originalProductData.images ? [...originalProductData.images] : [];
      }

      // Update display
      updateProductDisplay();

      // Exit edit mode
      toggleEditMode();

      showNotification("Changes discarded", "warning");
    }

    // Product Actions
    function toggleProductStatus(status) {
      if (!currentProduct || isEditMode) return;

      const oldStatus = currentProduct.status;
      currentProduct.status = status;

      console.log(`Changing status from ${oldStatus} to ${status}`);

      // Update in products array
      const index = products.findIndex(p => p.id === currentProduct.id);
      if (index !== -1) {
        products[index] = currentProduct;
        localStorage.setItem("products", JSON.stringify(products));
      }

      // Ensure activity array exists
      if (!currentProduct.activity) {
        currentProduct.activity = [];
      }

      // Add activity
      const today = new Date();
      const timeString = today.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      currentProduct.activity.unshift({
        date: `Today, ${timeString}`,
        content: `Status changed from ${oldStatus} to ${status}`
      });

      updateProductDisplay();
      showNotification(`Product status changed to ${status}`, "success");
    }

    function toggleFeatured() {
      if (!currentProduct || isEditMode) return;

      currentProduct.isFeatured = !currentProduct.isFeatured;

      // Update in products array
      const index = products.findIndex(p => p.id === currentProduct.id);
      if (index !== -1) {
        products[index] = currentProduct;
        localStorage.setItem("products", JSON.stringify(products));
      }

      // Ensure activity array exists
      if (!currentProduct.activity) {
        currentProduct.activity = [];
      }

      // Add activity
      const today = new Date();
      const timeString = today.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      currentProduct.activity.unshift({
        date: `Today, ${timeString}`,
        content: currentProduct.isFeatured ? "Product marked as featured" : "Product removed from featured"
      });

      updateProductDisplay();
      showNotification(
        currentProduct.isFeatured
          ? "Product marked as featured"
          : "Product removed from featured",
        "success"
      );
    }

    function deleteProduct() {
      if (!currentProduct || isEditMode) return;

      if (confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
        // Remove from products array
        const index = products.findIndex(p => p.id === currentProduct.id);
        if (index !== -1) {
          products.splice(index, 1);
          localStorage.setItem("products", JSON.stringify(products));
        }

        showNotification("Product deleted successfully", "success");

        // Show deleted message
        setTimeout(() => {
          document.getElementById("productDetail").style.display = "none";
          document.getElementById("productNotFound").style.display = "block";
          document.getElementById("productNotFound").innerHTML = `
            <div style="text-align: center; padding: 50px; background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
              <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 20px;"></i>
              <h2>Product Deleted</h2>
              <p>The product has been successfully deleted.</p>
              <button class="btn btn-primary" style="margin-top: 20px;" onclick="goToProductsList()">
                <i class="fas fa-arrow-left"></i> Back to Products List
              </button>
            </div>
          `;
        }, 500);
      }
    }

    function showProductNotFound() {
      const loading = document.getElementById("loading");
      const productNotFound = document.getElementById("productNotFound");

      loading.style.display = "none";
      productNotFound.style.display = "block";
    }

    function goToProductsList() {
      window.location.href = "?id=1";
    }

    // Utility Functions
    function showNotification(message, type = "info") {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => {
        notification.remove();
      });

      // Create notification element
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = "slideOut 0.3s ease";
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Keyboard shortcut for edit mode
    document.addEventListener('keydown', function (e) {
      // Ctrl+E to toggle edit mode
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        toggleEditMode();
      }
      // Escape to cancel edit mode
      if (e.key === 'Escape' && isEditMode) {
        cancelEdit();
      }
    });
  </script>
</body>

</html>